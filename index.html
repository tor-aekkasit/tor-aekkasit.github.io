
<!DOCTYPE html>
<html lang="th">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>แบบฟอร์มเอาประกันภัยโดรน</title>
    <!-- TailwindCSS via CDN for rapid styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Import Sarabun font for a clean and modern Thai typeface -->
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;600&display=swap" rel="stylesheet" />
    <style>
      /* Custom error styling for invalid fields */
      .error-message {
        color: #dc2626; /* Tailwind red-600 */
        font-size: 0.875rem;
        margin-top: 0.25rem;
      }
      .error-input {
        border-color: #dc2626;
      }
      /* Global font and blue themed UI adjustments */
      body {
        font-family: 'Sarabun', sans-serif;
      }
      /* Use a light blue background for the page */
      body.bg-gray-100 {
        background-color: #ebf8ff; /* Tailwind blue-100 */
      }
      /* Container background set to white to contrast with page background */
      .container-bg {
        background-color: #ffffff;
      }
      /* Fieldset border and legend coloring */
      fieldset {
        border-color: #93c5fd; /* Tailwind blue-300 */
        background-color: #ffffff;
      }
      legend {
        color: #1d4ed8; /* Tailwind blue-700 */
      }
      /* Labels use dark blue for readability */
      label {
        color: #1e3a8a; /* Tailwind blue-800 */
      }
      /* Inputs and selects with blue borders */
      input[type="text"], input[type="number"], input[type="email"], input[type="tel"], input[type="date"], select {
        border-color: #93c5fd;
      }
      /* Buttons with consistent blue theme */
      button {
        background-color: #1d4ed8;
      }
      button:hover {
        background-color: #2563eb;
      }

      /* Notification styles */
      #notification.success {
        background-color: #d1fae5; /* green-100 */
        color: #065f46; /* green-800 */
      }
      #notification.error {
        background-color: #fee2e2; /* red-100 */
        color: #991b1b; /* red-700 */
      }
    </style>
  </head>
  <body class="bg-gray-100 py-8">
    <div class="max-w-5xl mx-auto container-bg p-8 shadow-lg rounded-lg">
      <h1 class="text-3xl font-bold mb-6 text-center">แบบฟอร์มเอาประกันภัยโดรน</h1>
      <form id="insuranceForm" novalidate>
        <!-- ส่วนข้อมูลลำดับ แผนประกันภัย และวันเริ่มความคุ้มครองถูกตัดออกตามคำขอของผู้ใช้ -->
        <!-- กลุ่มข้อมูลผู้เอาประกันภัย -->
        <fieldset class="border border-blue-300 p-4 mb-6 rounded">
          <legend class="font-semibold text-lg px-2">ข้อมูลผู้เอาประกันภัย</legend>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="flex flex-col">
              <label for="insureprefix" class="mb-1 font-medium">คำนำหน้าชื่อ<span class="text-red-500">*</span></label>
              <select id="insureprefix" name="insureprefix" class="w-full border rounded p-2">
                <option value="">-- เลือกคำนำหน้า --</option>
                <option value="นาย">นาย</option>
                <option value="นาง">นาง</option>
                <option value="นางสาว">นางสาว</option>
              </select>
            </div>
            <div class="flex flex-col">
              <label for="insurename" class="mb-1 font-medium">ชื่อผู้เอาประกันภัย<span class="text-red-500">*</span></label>
              <input type="text" id="insurename" name="insurename" class="w-full border rounded p-2" placeholder="ชื่อ" />
            </div>
            <div class="flex flex-col">
              <label for="insuresurname" class="mb-1 font-medium">นามสกุลผู้เอาประกันภัย<span class="text-red-500">*</span></label>
              <input type="text" id="insuresurname" name="insuresurname" class="w-full border rounded p-2" placeholder="นามสกุล" />
            </div>
            <div class="flex flex-col">
              <label for="inscardtype" class="mb-1 font-medium">ประเภทบัตร<span class="text-red-500">*</span></label>
              <select id="inscardtype" name="inscardtype" class="w-full border rounded p-2">
                <option value="">-- เลือกประเภทบัตร --</option>
                <option value="I">บัตรประชาชน (I)</option>
                <option value="P">พาสปอร์ต (P)</option>
              </select>
            </div>
            <div class="flex flex-col">
              <label for="insidcard" class="mb-1 font-medium">เลขที่บัตรประชาชน/Passport<span class="text-red-500">*</span></label>
              <input type="text" id="insidcard" name="insidcard" class="w-full border rounded p-2" placeholder="กรอกเลขที่บัตร" />
            </div>
            <div class="flex flex-col">
              <label for="insbirthdate" class="mb-1 font-medium">วันเกิด<span class="text-red-500">*</span></label>
              <!-- ใช้ input type=date เพื่อให้สามารถเลือกวัน เดือน ปี ได้ -->
              <input type="date" id="insbirthdate" name="insbirthdate" class="w-full border rounded p-2" />
            </div>
            <div class="flex flex-col">
              <label for="insemail" class="mb-1 font-medium">อีเมล์ผู้เอาประกัน<span class="text-red-500">*</span></label>
              <input type="email" id="insemail" name="insemail" class="w-full border rounded p-2" placeholder="example@domain.com" />
            </div>
            <div class="flex flex-col">
              <label for="insphone" class="mb-1 font-medium">เบอร์โทรศัพท์ผู้เอาประกันภัย<span class="text-red-500">*</span></label>
              <input type="tel" id="insphone" name="insphone" class="w-full border rounded p-2" placeholder="0xxxxxxxxx" />
            </div>
          </div>
        </fieldset>
        <!-- กลุ่มข้อมูลที่อยู่ -->
        <fieldset class="border border-blue-300 p-4 mb-6 rounded">
          <legend class="font-semibold text-lg px-2">ข้อมูลที่อยู่ผู้เอาประกันภัย</legend>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="flex flex-col">
              <label for="address1" class="mb-1 font-medium">ที่อยู่เลขที่<span class="text-red-500">*</span></label>
              <input type="text" id="address1" name="address1" class="w-full border rounded p-2" placeholder="บ้านเลขที่" />
            </div>
            <div class="flex flex-col">
              <label for="address2" class="mb-1 font-medium">อาคาร/หมู่บ้าน</label>
              <input type="text" id="address2" name="address2" class="w-full border rounded p-2" placeholder="อาคาร/หมู่บ้าน" />
            </div>
            <div class="flex flex-col">
              <label for="address3" class="mb-1 font-medium">ตรอก/ซอย</label>
              <input type="text" id="address3" name="address3" class="w-full border rounded p-2" placeholder="ตรอก/ซอย" />
            </div>
            <div class="flex flex-col">
              <label for="address4" class="mb-1 font-medium">ถนน</label>
              <input type="text" id="address4" name="address4" class="w-full border rounded p-2" placeholder="ถนน" />
            </div>
            <!-- เรียงลำดับจังหวัดก่อน แล้วอำเภอ และสุดท้ายตำบล -->
            <div class="flex flex-col">
              <label for="province" class="mb-1 font-medium">จังหวัด<span class="text-red-500">*</span></label>
              <select id="province" name="province" class="w-full border rounded p-2"></select>
            </div>
            <div class="flex flex-col">
              <label for="amphur" class="mb-1 font-medium">อำเภอ<span class="text-red-500">*</span></label>
              <!-- รายการอำเภอจะถูกสร้างแบบ dynamic ตามจังหวัดที่เลือก -->
              <select id="amphur" name="amphur" class="w-full border rounded p-2" disabled>
                <option value="">-- เลือกอำเภอ --</option>
              </select>
            </div>
            <div class="flex flex-col">
              <label for="district" class="mb-1 font-medium">ตำบล<span class="text-red-500">*</span></label>
              <!-- รายการตำบลจะถูกสร้างแบบ dynamic ตามอำเภอที่เลือก -->
              <select id="district" name="district" class="w-full border rounded p-2" disabled>
                <option value="">-- เลือกตำบล --</option>
              </select>
            </div>
            <div class="flex flex-col">
              <label for="zipcode" class="mb-1 font-medium">รหัสไปรษณีย์<span class="text-red-500">*</span></label>
              <input type="text" id="zipcode" name="zipcode" class="w-full border rounded p-2" placeholder="รหัสไปรษณีย์" readonly />
            </div>
          </div>
        </fieldset>
        <!-- กลุ่มข้อมูลเกี่ยวกับ Drone -->
        <fieldset class="border border-blue-300 p-4 mb-6 rounded">
          <legend class="font-semibold text-lg px-2">ข้อมูลเกี่ยวกับ Drone</legend>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="flex flex-col">
              <label for="BrandModel" class="mb-1 font-medium">ยี่ห้อและรุ่น<span class="text-red-500">*</span></label>
              <input type="text" id="BrandModel" name="BrandModel" class="w-full border rounded p-2" placeholder="Brand / Model" />
            </div>
            <div class="flex flex-col">
              <label for="Year" class="mb-1 font-medium">ปี Drone (ปีค.ศ.)<span class="text-red-500">*</span></label>
              <!-- เปลี่ยนเป็น select เพื่อให้เลือกปีได้ -->
              <select id="Year" name="Year" class="w-full border rounded p-2">
                <option value="">-- เลือกปี --</option>
              </select>
            </div>
            <div class="flex flex-col">
              <label for="SerialNo" class="mb-1 font-medium">หมายเลขประจำเครื่อง<span class="text-red-500">*</span></label>
              <input type="text" id="SerialNo" name="SerialNo" class="w-full border rounded p-2" placeholder="Serial Number" />
            </div>
            <!-- ส่วนเลือกน้ำหนักโดรนและแพ็คเกจจะย้ายไปอยู่ในกลุ่มข้อมูลแผนประกันภัย -->
          </div>
          <!-- จำนวนผู้บังคับโดรน และฟิลด์กรอกชื่อผู้บังคับแบบไดนามิก -->
          <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="flex flex-col">
              <label for="numControllers" class="mb-1 font-medium">จำนวนผู้บังคับ<span class="text-red-500">*</span></label>
              <select id="numControllers" name="numControllers" class="w-full border rounded p-2">
                <option value="">-- เลือกจำนวนผู้บังคับ --</option>
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4">4</option>
                <option value="5">5</option>
                <option value="6">6</option>
                <option value="7">7</option>
                <option value="8">8</option>
                <option value="9">9</option>
                <option value="10">10</option>
              </select>
            </div>
          </div>
          <!-- คอนเทนเนอร์สำหรับสร้างฟิลด์ชื่อผู้บังคับตามจำนวนที่เลือก -->
          <div id="controllerInputs" class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4"></div>
        </fieldset>

        <!-- กลุ่มข้อมูลแผนประกันภัย -->
        <fieldset class="border border-blue-300 p-4 mb-6 rounded">
          <legend class="font-semibold text-lg px-2">ข้อมูลแผนประกันภัย</legend>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="flex flex-col">
              <label for="droneWeight" class="mb-1 font-medium">น้ำหนักโดรน<span class="text-red-500">*</span></label>
              <select id="droneWeight" name="droneWeight" class="w-full border rounded p-2">
                <option value="">-- เลือกน้ำหนักโดรน --</option>
                <option value="<=25">น้ำหนักโดรนไม่เกิน 25 กก. ทุน 1 ล้าน</option>
                <option value="25.01-50">น้ำหนักโดรนไม่เกิน 25.01 - 50 กก. ทุน 2 ล้าน</option>
                <option value="<=70">น้ำหนักโดรนไม่เกิน 70 กก. ทุน 2 ล้าน</option>
                <option value="<=100">น้ำหนักโดรนไม่เกิน 100 กก. ทุน 2 ล้าน</option>
              </select>
            </div>
            <div class="flex flex-col">
              <label for="packageSelect" class="mb-1 font-medium">แพ็คเกจ<span class="text-red-500">*</span></label>
              <select id="packageSelect" name="packageSelect" class="w-full border rounded p-2" disabled>
                <option value="">-- เลือกแพ็คเกจ --</option>
              </select>
            </div>
          </div>
        </fieldset>

        <div class="mt-6 flex justify-center">
          <button type="submit" class="px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded">ส่งข้อมูล</button>
        </div>
        <!-- Notification area for success/error messages -->
        <div id="notification" class="fixed top-5 right-5 z-50 hidden px-4 py-2 rounded shadow"></div>
      </form>
    </div>
    <!-- JavaScript for dynamic behavior and validation -->
    <!-- โหลดข้อมูลที่อยู่แบบจัดโครงสร้างจากไฟล์ address_data.js -->
    <script src="address_data.js"></script>
    <script>
      // Mapping of provinces to a representative postal code.
      // Derived from an open dataset that lists postal codes for each Thai province【783817973408927†L1388-L1496】.
      const provinceZip = {
        "กระบี่": "81000",
        "กรุงเทพมหานคร": "10200",
        "กาญจนบุรี": "71000",
        "กาฬสินธุ์": "46000",
        "กำแพงเพชร": "62000",
        "ขอนแก่น": "40000",
        "จันทบุรี": "22000",
        "ฉะเชิงเทรา": "24000",
        "ชลบุรี": "20000",
        "ชัยนาท": "17000",
        "ชัยภูมิ": "36000",
        "ชุมพร": "86000",
        "ตรัง": "92000",
        "ตราด": "23000",
        "ตาก": "63000",
        "นครนายก": "26000",
        "นครปฐม": "73000",
        "นครพนม": "48000",
        "นครราชสีมา": "30000",
        "นครศรีธรรมราช": "80000",
        "นครสวรรค์": "60000",
        "นนทบุรี": "11000",
        "นราธิวาส": "96000",
        "น่าน": "55000",
        "บึงกาฬ": "38000",
        "บุรีรัมย์": "31000",
        "ปทุมธานี": "12000",
        "ประจวบคีรีขันธ์": "77000",
        "ปราจีนบุรี": "25000",
        "ปัตตานี": "94000",
        "พระนครศรีอยุธยา": "13000",
        "พะเยา": "56000",
        "พังงา": "82000",
        "พัทลุง": "93000",
        "พิจิตร": "66000",
        "พิษณุโลก": "65000",
        "ภูเก็ต": "83000",
        "มหาสารคาม": "44000",
        "มุกดาหาร": "49000",
        "ยะลา": "95000",
        "ยโสธร": "35000",
        "ระนอง": "85000",
        "ระยอง": "21000",
        "ราชบุรี": "70000",
        "ร้อยเอ็ด": "45000",
        "ลพบุรี": "15000",
        "ลำปาง": "52000",
        "ลำพูน": "51000",
        "ศรีสะเกษ": "33000",
        "สกลนคร": "47000",
        "สงขลา": "90000",
        "สตูล": "91000",
        "สมุทรปราการ": "10270",
        "สมุทรสงคราม": "75000",
        "สมุทรสาคร": "74000",
        "สระบุรี": "18000",
        "สระแก้ว": "27000",
        "สิงห์บุรี": "16000",
        "สุพรรณบุรี": "72000",
        "สุราษฎร์ธานี": "84000",
        "สุรินทร์": "32000",
        "สุโขทัย": "64000",
        "หนองคาย": "43000",
        "หนองบัวลำภู": "39000",
        "อำนาจเจริญ": "37000",
        "อุดรธานี": "41000",
        "อุตรดิตถ์": "53000",
        "อุทัยธานี": "61000",
        "อุบลราชธานี": "34000",
        "อ่างทอง": "14000",
        "เชียงราย": "57000",
        "เชียงใหม่": "50200",
        "เพชรบุรี": "76000",
        "เพชรบูรณ์": "67000",
        "เลย": "42000",
        "แพร่": "54000",
        "แม่ฮ่องสอน": "58000",
      };

      // ข้อมูลที่อยู่แบบละเอียด (จังหวัด-อำเภอ-ตำบล-รหัสไปรษณีย์) มาจากไฟล์ address_data.js
      // addressData จะถูกประกาศในไฟล์ address_data.js
      const addressDataLoaded = (typeof addressData !== 'undefined') ? addressData : {};

      // ดึง DOM elements สำหรับที่อยู่
      const provinceSelect = document.getElementById('province');
      const amphurSelect = document.getElementById('amphur');
      const districtSelect = document.getElementById('district');
      const zipcodeInput = document.getElementById('zipcode');

      // ดึง DOM elements สำหรับปีและผู้บังคับโดรน
      const yearSelect = document.getElementById('Year');
      const numControllersSelect = document.getElementById('numControllers');
      const controllerContainer = document.getElementById('controllerInputs');

      // ดึง DOM elements สำหรับน้ำหนักโดรนและแพ็คเกจ
      const droneWeightSelect = document.getElementById('droneWeight');
      const packageSelect = document.getElementById('packageSelect');

      // ข้อมูลแพ็คเกจตามน้ำหนักโดรน
      const packagesByWeight = {
        "<=25": [
          { price: '1080', company: 'บริษัท เจมาร์ท' },
          { price: '999', company: 'บริษัท ไทยพัฒนา' },
        ],
        "25.01-50": [
          { price: '2370', company: 'บริษัท เจมาร์ท' },
          { price: '2820', company: 'บริษัท เจมาร์ท' },
          { price: '2329', company: 'บริษัท ไทยพัฒนา' },
          { price: '2429', company: 'บริษัท ไทยพัฒนา' },
          { price: '3000', company: 'บริษัท กรุงเทพ' },
          { price: '2090', company: 'บริษัท ทิพย' },
          { price: '2490', company: 'บริษัท ทิพย' },
        ],
        "<=70": [
          { price: '3120', company: 'บริษัท เจมาร์ท' },
          { price: '3570', company: 'บริษัท เจมาร์ท' },
          { price: '3000', company: 'บริษัท กรุงเทพ' },
          { price: '2090', company: 'บริษัท ทิพย' },
          { price: '2490', company: 'บริษัท ทิพย' },
        ],
        "<=100": [
          { price: '4320', company: 'บริษัท เจมาร์ท' },
          { price: '4920', company: 'บริษัท เจมาร์ท' },
          { price: '3729', company: 'บริษัท ไทยพัฒนา' },
          { price: '3829', company: 'บริษัท ไทยพัฒนา' },
          { price: '3000', company: 'บริษัท กรุงเทพ' },
          { price: '2090', company: 'บริษัท ทิพย' },
          { price: '2490', company: 'บริษัท ทิพย' },
        ],
      };

      // เมื่อเลือกน้ำหนักโดรน ให้แสดงรายการแพ็คเกจที่เกี่ยวข้อง
      function updatePackageOptions() {
        const weight = droneWeightSelect.value;
        // รีเซ็ตแพ็คเกจ
        packageSelect.innerHTML = '<option value="">-- เลือกแพ็คเกจ --</option>';
        if (packagesByWeight[weight]) {
          packageSelect.disabled = false;
          packagesByWeight[weight].forEach(pkg => {
            const option = document.createElement('option');
            option.value = `${pkg.price}|${pkg.company}`;
            option.textContent = `${pkg.price} บาท - ${pkg.company}`;
            packageSelect.appendChild(option);
          });
        } else {
          packageSelect.disabled = true;
        }
      }

      // ผูกอีเวนต์เมื่อเลือกน้ำหนักโดรน
      droneWeightSelect.addEventListener('change', updatePackageOptions);

      // URL สำหรับ webhook ทดสอบ (เปลี่ยนเป็น production URL เมื่อต้องการใช้งานจริง)
      const webhookURL = 'https://techs.co.th/webhook-test/d6358ab9-165a-4f51-8b17-dce91d5bc9e4';

      // ฟังก์ชันแสดงข้อความแจ้งเตือน (success/error)
      function showNotification(message, type) {
        const notificationEl = document.getElementById('notification');
        notificationEl.textContent = message;
        // เอาคลาสออกก่อนแล้วใส่ใหม่
        notificationEl.classList.remove('hidden', 'success', 'error');
        notificationEl.classList.add(type);
        // หลังจาก 4 วินาทีให้ซ่อนข้อความ
        setTimeout(() => {
          notificationEl.classList.add('hidden');
        }, 4000);
      }

      // เติมรายการปี (ตั้งแต่ปี 2000 ถึงปีปัจจุบัน)
      function populateYearOptions() {
        const currentYear = new Date().getFullYear();
        for (let y = currentYear; y >= 2000; y--) {
          const opt = document.createElement('option');
          opt.value = String(y);
          opt.textContent = String(y);
          yearSelect.appendChild(opt);
        }
      }

      // เมื่อเลือกจำนวนผู้บังคับ ให้สร้างฟิลด์กรอกชื่อ
      function updateControllerFields() {
        const count = parseInt(numControllersSelect.value);
        // ล้างรายการเดิม
        controllerContainer.innerHTML = '';
        if (!isNaN(count) && count > 0) {
          for (let i = 1; i <= count; i++) {
            const div = document.createElement('div');
            div.className = 'flex flex-col';
            const label = document.createElement('label');
            label.className = 'mb-1 font-medium';
            label.setAttribute('for', 'NameControl' + i);
            label.textContent = 'ชื่อผู้บังคับคนที่ ' + i + (i === 1 ? '*' : '');
            const input = document.createElement('input');
            input.type = 'text';
            input.id = 'NameControl' + i;
            input.name = 'NameControl' + i;
            input.className = 'w-full border rounded p-2';
            div.appendChild(label);
            div.appendChild(input);
            controllerContainer.appendChild(div);
          }
        }
      }

      // ผูกอีเวนต์สำหรับการเปลี่ยนจำนวนผู้บังคับ
      numControllersSelect.addEventListener('change', updateControllerFields);

      // เติมรายชื่อจังหวัดลงใน select (ใช้ข้อมูล addressDataLoaded)
      // เริ่มต้นด้วยตัวเลือก placeholder "-- เลือกจังหวัด --"
      provinceSelect.innerHTML = '<option value="">-- เลือกจังหวัด --</option>';
      for (const prov of Object.keys(addressDataLoaded).sort()) {
        const option = document.createElement('option');
        option.value = prov;
        option.textContent = prov;
        provinceSelect.appendChild(option);
      }

      // เมื่อเลือกจังหวัด ให้แสดงรายการอำเภอ (amphur) และเปิด/ปิดการเลือกตามลำดับ
      function updateAmphur() {
        const provName = provinceSelect.value;
        // รีเซ็ตอำเภอและตำบล พร้อมปิดการเลือก
        amphurSelect.innerHTML = '<option value="">-- เลือกอำเภอ --</option>';
        districtSelect.innerHTML = '<option value="">-- เลือกตำบล --</option>';
        zipcodeInput.value = '';
        if (provName && addressDataLoaded[provName]) {
          // เปิดการเลือกอำเภอเมื่อเลือกจังหวัดแล้ว
          amphurSelect.disabled = false;
          districtSelect.disabled = true;
          const districts = Object.keys(addressDataLoaded[provName]).sort();
          districts.forEach(dist => {
            const option = document.createElement('option');
            option.value = dist;
            option.textContent = dist;
            amphurSelect.appendChild(option);
          });
        } else {
          // หากยังไม่เลือกจังหวัด ให้ปิดอำเภอและตำบล
          amphurSelect.disabled = true;
          districtSelect.disabled = true;
        }
      }

      // เมื่อเลือกอำเภอ ให้แสดงรายการตำบล (district) และจัดการเปิด/ปิดการเลือก
      function updateDistricts() {
        const provName = provinceSelect.value;
        const amphurName = amphurSelect.value;
        districtSelect.innerHTML = '<option value="">-- เลือกตำบล --</option>';
        zipcodeInput.value = '';
        if (provName && amphurName && addressDataLoaded[provName] && addressDataLoaded[provName][amphurName]) {
          districtSelect.disabled = false;
          const subdistricts = Object.keys(addressDataLoaded[provName][amphurName]).sort();
          subdistricts.forEach(sub => {
            const option = document.createElement('option');
            option.value = sub;
            option.textContent = sub;
            districtSelect.appendChild(option);
          });
        } else {
          districtSelect.disabled = true;
        }
      }

      // เมื่อเลือกตำบล ให้ตั้งค่ารหัสไปรษณีย์
      function updateZipFromSelection() {
        const provName = provinceSelect.value;
        const amphurName = amphurSelect.value;
        const subName = districtSelect.value;
        if (provName && amphurName && subName && addressDataLoaded[provName] && addressDataLoaded[provName][amphurName]) {
          const zip = addressDataLoaded[provName][amphurName][subName];
          zipcodeInput.value = zip || '';
        } else {
          zipcodeInput.value = '';
        }
      }

      // เชื่อมต่ออีเวนต์ของ dropdown
      provinceSelect.addEventListener('change', () => {
        updateAmphur();
      });
      amphurSelect.addEventListener('change', () => {
        updateDistricts();
      });
      districtSelect.addEventListener('change', () => {
        updateZipFromSelection();
      });

      // Prefill default values for other fields
      function prefillDefaults() {
        // ไม่ตั้งค่า default ลำดับที่และ Plan Code เพื่อให้ผู้ใช้กรอกเอง
        // เติมรายการปีในการใช้งานครั้งแรก
        populateYearOptions();
        // คำนวณปีปัจจุบันสำหรับการตั้งค่าปีของโดรนเป็นค่าเริ่มต้น
        const now = new Date();
        yearSelect.value = String(now.getFullYear());
        // ไม่ตั้งค่า default วันเกิด
        document.getElementById('insbirthdate').value = '';
        // ไม่ต้องตั้งค่า default ที่อยู่หรือจังหวัด
      }

      document.addEventListener('DOMContentLoaded', () => {
        prefillDefaults();
      });

      // Validation helpers
      function showError(element, message) {
        element.classList.add('error-input');
        let msgEl = element.parentElement.querySelector('.error-message');
        if (!msgEl) {
          msgEl = document.createElement('div');
          msgEl.className = 'error-message';
          element.parentElement.appendChild(msgEl);
        }
        msgEl.textContent = message;
      }
      function clearError(element) {
        element.classList.remove('error-input');
        const msgEl = element.parentElement.querySelector('.error-message');
        if (msgEl) {
          msgEl.textContent = '';
        }
      }

      // Regular expressions for validation
      const emailPattern = /^[\w\-.]+@([\w-]+\.)+[\w-]{2,4}$/;
      const phonePattern = /^0\d{8,9}$/;
      const idCardPattern = /^\d{13}$/;
      const passportPattern = /^[A-Za-z0-9]{6,15}$/;

      // Main validation on form submit
      document.getElementById('insuranceForm').addEventListener('submit', function (event) {
        event.preventDefault();
        let valid = true;
        // Clear previous errors
        const fields = [
          'insureprefix', 'insurename', 'insuresurname', 'inscardtype',
          'insidcard', 'insbirthdate', 'insemail', 'insphone', 'address1', 'district', 'amphur', 'province',
          'zipcode', 'BrandModel', 'Year', 'SerialNo', 'droneWeight', 'packageSelect', 'numControllers'
        ];
        fields.forEach(id => {
          const el = document.getElementById(id);
          clearError(el);
        });
        // Validate each required field
        function required(id, message) {
          const el = document.getElementById(id);
          if (!el.value || el.value.trim() === '') {
            showError(el, message);
            valid = false;
          }
        }
        // ไม่ต้องตรวจสอบลำดับที่, แผนประกันภัย และวันเริ่มความคุ้มครอง เนื่องจากถูกตัดออก
        required('insureprefix', 'กรุณาเลือกคำนำหน้า');
        required('insurename', 'กรุณากรอกชื่อ');
        required('insuresurname', 'กรุณากรอกนามสกุล');
        required('inscardtype', 'กรุณาเลือกประเภทบัตร');
        required('insidcard', 'กรุณากรอกเลขบัตร');
        required('insbirthdate', 'กรุณากรอกวันเกิด');
        required('insemail', 'กรุณากรอกอีเมล์');
        required('insphone', 'กรุณากรอกเบอร์โทรศัพท์');
        required('address1', 'กรุณากรอกบ้านเลขที่');
        required('district', 'กรุณาเลือกตำบล');
        required('amphur', 'กรุณาเลือกอำเภอ');
        required('province', 'กรุณาเลือกจังหวัด');
        required('zipcode', 'กรุณากรอกรหัสไปรษณีย์');
        required('BrandModel', 'กรุณากรอกยี่ห้อและรุ่น');
        required('Year', 'กรุณาเลือกปีของโดรน');
        required('SerialNo', 'กรุณากรอกหมายเลขประจำเครื่อง');
        required('droneWeight', 'กรุณาเลือกน้ำหนักโดรน');
        required('packageSelect', 'กรุณาเลือกแพ็คเกจ');
        // การตรวจสอบชื่อผู้บังคับจะทำแบบไดนามิกด้านล่าง

        // Additional pattern validations
        // สำหรับ input type=date ไม่จำเป็นต้องตรวจสอบด้วย regex; browser จัดการรูปแบบให้แล้ว
        const emailEl = document.getElementById('insemail');
        if (emailEl.value && !emailPattern.test(emailEl.value)) {
          showError(emailEl, 'รูปแบบอีเมล์ไม่ถูกต้อง');
          valid = false;
        }
        const phoneEl = document.getElementById('insphone');
        if (phoneEl.value && !phonePattern.test(phoneEl.value)) {
          showError(phoneEl, 'รูปแบบเบอร์โทรศัพท์ไม่ถูกต้อง');
          valid = false;
        }
        const idType = document.getElementById('inscardtype').value;
        const idEl = document.getElementById('insidcard');
        if (idType === 'I') {
          if (idEl.value && !idCardPattern.test(idEl.value)) {
            showError(idEl, 'เลขที่บัตรประชาชนต้องเป็นตัวเลข 13 หลัก');
            valid = false;
          }
        } else if (idType === 'P') {
          if (idEl.value && !passportPattern.test(idEl.value)) {
            showError(idEl, 'หมายเลขพาสปอร์ตต้องมีอักขระ 6-15 ตัว');
            valid = false;
          }
        }
        // Validate Year as 4-digit year
        const yearEl = document.getElementById('Year');
        if (yearEl.value && !(yearEl.value.length === 4 && !isNaN(yearEl.value))) {
          showError(yearEl, 'ปีต้องเป็นเลข 4 หลัก');
          valid = false;
        }
        // Validate dynamic controller names
        const numCtrl = parseInt(document.getElementById('numControllers').value);
        if (!isNaN(numCtrl) && numCtrl > 0) {
          for (let i = 1; i <= numCtrl; i++) {
            const ctrlInput = document.getElementById('NameControl' + i);
            if (ctrlInput && (ctrlInput.value.trim() === '')) {
              showError(ctrlInput, 'กรุณากรอกชื่อผู้บังคับคนที่ ' + i);
              valid = false;
            }
          }
        }
        // If valid, send data to n8n webhook via POST
        if (valid) {
          // รวบรวมข้อมูลจากฟอร์มลงในอ็อบเจ็กต์
          const formDataObj = {};
          // เก็บค่าจากทุกฟิลด์ที่ระบุใน fields
          fields.forEach(id => {
            const el = document.getElementById(id);
            if (el) {
              formDataObj[id] = el.value;
            }
          });
          // เก็บชื่อผู้บังคับทั้งหมดในอาร์เรย์ controllers
          const numCtrlSend = parseInt(document.getElementById('numControllers').value);
          if (!isNaN(numCtrlSend) && numCtrlSend > 0) {
            formDataObj.controllers = [];
            for (let i = 1; i <= numCtrlSend; i++) {
              const ctrlInput = document.getElementById('NameControl' + i);
              if (ctrlInput) {
                formDataObj.controllers.push(ctrlInput.value);
              }
            }
          }
          // ส่งข้อมูลไปยัง webhook URL
          fetch(webhookURL, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(formDataObj)
          })
            .then(response => {
              if (response.ok) {
                showNotification('ส่งข้อมูลเรียบร้อยแล้ว', 'success');
              } else {
                showNotification('เกิดข้อผิดพลาดในการส่งข้อมูล', 'error');
              }
            })
            .catch(error => {
              console.error('Error sending webhook:', error);
              showNotification('เกิดข้อผิดพลาดในการส่งข้อมูล', 'error');
            });
        }
      });
    </script>
  </body>
</html>
